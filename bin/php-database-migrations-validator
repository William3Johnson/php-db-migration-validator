#!/usr/bin/env php
<?php

use AK\DatabaseMigrationValidator\IrreversibleMigrationsValidator;

if (!in_array(PHP_SAPI, ['cli', 'phpdbg', 'embed'], true)) {
    echo 'Warning: The console should be invoked via the CLI version of PHP, not the ' . PHP_SAPI . ' SAPI' . PHP_EOL;
    exit(2);
}

$composerAutoload = [
    __DIR__ . '/../vendor/autoload.php', // standalone with "composer install" run
    __DIR__ . '/../../../autoload.php',  // script is installed as a composer binary
];
foreach ($composerAutoload as $autoload) {
    if (file_exists($autoload)) {
        require($autoload);
        break;
    }
}

// Send all errors to stderr
ini_set('display_errors', 'stderr');
// open streams if not in CLI sapi
defined('STDOUT') or define('STDOUT', fopen('php://stdout', 'w'));
defined('STDERR') or define('STDERR', fopen('php://stderr', 'w'));

$command = null;
$inputDirectoryPath = null;
foreach ($argv as $k => $arg) {
    if ($k === 0) {
        continue;
    }

    if ($command === null) {
        $command = $arg;
    }

    if ($k === 2) {
        $inputDirectoryPath = rtrim($arg, '/');
    }
}

if ($inputDirectoryPath === null) {
    echo 'Missing `migrations-directory-path` argument' . PHP_EOL;

    exit(2);
}

switch ($command) {
    case 'irreversible':
        $exitCode = (new IrreversibleMigrationsValidator())($inputDirectoryPath);

        exit($exitCode);
    default:
        echo "Unknown command `$command`" . PHP_EOL;
        exit(2);
}
